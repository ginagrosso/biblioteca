{% extends 'gestion_libros/base.html' %}

{% block title %}Catálogo de Libros{% endblock %}

{% block content %}
<!-- Header de la página -->
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="bi bi-book-half me-3"></i>Catálogo de Libros
                </h1>
                <p class="mb-0 opacity-75">Explora y gestiona el catálogo de libros de la biblioteca</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalLibro" onclick="limpiarModalLibro()">
                        <i class="bi bi-plus-circle me-1"></i> Nuevo Libro
                    </button>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalEjemplar" onclick="limpiarModalEjemplar()">
                        <i class="bi bi-plus-circle me-1"></i> Nuevo Ejemplar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Barra de búsqueda -->
<div class="search-container">
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label for="q" class="form-label">
                <i class="bi bi-search me-1"></i>Buscar
            </label>
            <input type="text" 
                   class="form-control" 
                   id="q" 
                   name="q" 
                   value="{{ query }}" 
                   placeholder="Ingresa tu búsqueda..."
                   autocomplete="off">
        </div>
        <div class="col-md-3">
            <label for="filtro" class="form-label">
                <i class="bi bi-funnel me-1"></i>Tipo de búsqueda
            </label>
            <select class="form-select" id="filtro" name="filtro">
                <option value="todos" {% if filtro_tipo == 'todos' %}selected{% endif %}>Todos los campos</option>
                <option value="isbn" {% if filtro_tipo == 'isbn' %}selected{% endif %}>ISBN</option>
                <option value="titulo" {% if filtro_tipo == 'titulo' %}selected{% endif %}>Título</option>
                <option value="autor" {% if filtro_tipo == 'autor' %}selected{% endif %}>Autor</option>
                <option value="editorial" {% if filtro_tipo == 'editorial' %}selected{% endif %}>Editorial</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-search me-1"></i> Buscar
            </button>
            {% if query %}
            <a href="{% url 'listar_libros' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i> Limpiar
            </a>
            {% endif %}
        </div>
        <div class="col-md-2 d-flex align-items-end">
            {% if query %}
            <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                {{ total_resultados }} resultado{{ total_resultados|pluralize }}
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Contenido principal -->
<div class="card">
    <div class="card-body">
        {% if libros %}
        <div class="table-responsive">
            <table class="table table-hover" id="tabla-libros">
                <thead>
                    <tr>
                        <th><i class="bi bi-hash me-1"></i>ISBN</th>
                        <th><i class="bi bi-book me-1"></i>Título</th>
                        <th><i class="bi bi-person me-1"></i>Autor</th>
                        <th><i class="bi bi-building me-1"></i>Editorial</th>
                        <th><i class="bi bi-calendar me-1"></i>Año</th>
                        <th><i class="bi bi-check-circle me-1"></i>Disponibles</th>
                        <th><i class="bi bi-gear me-1"></i>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for libro in libros %}
                    <tr data-bs-toggle="collapse" data-bs-target="#ejemplares-{{ libro.isbn }}" style="cursor: pointer;">
                        <td>
                            <code class="bg-light px-2 py-1 rounded">{{ libro.isbn }}</code>
                        </td>
                        <td>
                            <strong>
                                <i class="bi bi-chevron-right me-1"></i>
                                {{ libro.titulo }}
                            </strong>
                        </td>
                        <td>{{ libro.autor }}</td>
                        <td>{{ libro.editorial|default:"—" }}</td>
                        <td>{{ libro.año_publicacion|default:"—" }}</td>
                        <td>
                            {% if libro.ejemplares_disponibles > 0 %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i>{{ libro.ejemplares_disponibles }}
                            </span>
                            {% else %}
                            <span class="badge bg-danger">
                                <i class="bi bi-x-circle me-1"></i>0
                            </span>
                            {% endif %}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" 
                                        class="btn btn-outline-success" 
                                        title="Agregar ejemplar"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEjemplar"
                                        onclick="limpiarModalEjemplar('{{ libro.isbn }}')">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-primary" 
                                        title="Editar libro"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalLibro"
                                        onclick="cargarLibroEnModal('{{ libro.isbn }}', '{{ libro.titulo|escapejs }}', '{{ libro.autor|escapejs }}', '{{ libro.editorial|default:''|escapejs }}', '{{ libro.año_publicacion|default:'' }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="post" action="{% url 'dar_baja_libro' libro.isbn %}" style="display: inline;" 
                                      onsubmit="return confirm('¿Dar de baja \"{{ libro.titulo|escapejs }}\" y todos sus ejemplares?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger" title="Dar de baja">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <!-- Fila expandible para mostrar ejemplares -->
                    <tr class="collapse" id="ejemplares-{{ libro.isbn }}">
                        <td colspan="7" style="background-color: var(--bg-toolbar); padding: 0;">
                            <div class="p-3">
                                <h6 class="mb-3">
                                    <i class="bi bi-collection me-2"></i>Ejemplares de este libro
                                </h6>
                                {% if libro.ejemplares.all %}
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Código</th>
                                                <th>Estado</th>
                                                <th>Fecha Adquisición</th>
                                                <th>Observaciones</th>
                                                <th style="min-width: 150px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ejemplar in libro.ejemplares.all %}
                                            {% if ejemplar.activo %}
                                            <tr>
                                                <td><code>{{ ejemplar.codigo_ejemplar }}</code></td>
                                                <td>
                                                    {% if ejemplar.estado == 'disponible' %}
                                                    <span class="badge bg-success">{{ ejemplar.get_estado_display }}</span>
                                                    {% elif ejemplar.estado == 'prestado' %}
                                                    <span class="badge bg-warning">{{ ejemplar.get_estado_display }}</span>
                                                    {% elif ejemplar.estado == 'mantenimiento' %}
                                                    <span class="badge bg-info">{{ ejemplar.get_estado_display }}</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">{{ ejemplar.get_estado_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ ejemplar.fecha_adquisicion|date:"d/m/Y" }}</td>
                                                <td>{{ ejemplar.observaciones|default:"—" }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" 
                                                                class="btn btn-outline-primary" 
                                                                title="Editar ejemplar"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#modalEjemplar"
                                                                onclick="cargarEjemplarEnModal('{{ ejemplar.codigo_ejemplar|escapejs }}', '{{ ejemplar.libro.isbn }}', '{{ ejemplar.estado }}', '{{ ejemplar.observaciones|default:''|escapejs }}')">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form method="post" action="{% url 'dar_baja_ejemplar' ejemplar.codigo_ejemplar %}" style="display: inline;" 
                                                              onsubmit="return confirm('¿Dar de baja el ejemplar {{ ejemplar.codigo_ejemplar|escapejs }}?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-outline-danger" title="Dar de baja">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <p class="text-muted mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    No hay ejemplares registrados para este libro.
                                </p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Total: {{ libros.count }} libro{{ libros.count|pluralize }}
                {% if query %}
                encontrado{{ total_resultados|pluralize }}
                {% endif %}
            </div>
            <div>
                <a href="{% url 'registrar_libro' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i> Agregar Nuevo Libro
                </a>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            {% if query %}
            <i class="bi bi-search"></i>
            <h4>No se encontraron resultados</h4>
            <p class="mb-4">No hay libros que coincidan con tu búsqueda: <strong>"{{ query }}"</strong></p>
            <div class="d-flex gap-2 justify-content-center">
                <a href="{% url 'listar_libros' %}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i> Ver Todos los Libros
                </a>
                <a href="{% url 'registrar_libro' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Agregar Libro
                </a>
            </div>
            {% else %}
            <i class="bi bi-book"></i>
            <h4>No hay libros en el catálogo</h4>
            <p class="mb-4">Comienza agregando el primer libro a tu biblioteca</p>
            <a href="{% url 'registrar_libro' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i> Agregar Primer Libro
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Unificado Libro (Crear/Editar) -->
<div class="modal fade" id="modalLibro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLibroTitulo"><i class="bi bi-plus-circle me-2"></i>Nuevo Libro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formLibro">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ISBN *</label>
                        <input type="text" class="form-control" name="isbn" id="libro_isbn" required>
                        <small class="text-muted">Código único del libro</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Título *</label>
                        <input type="text" class="form-control" name="titulo" id="libro_titulo" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Autor *</label>
                        <input type="text" class="form-control" name="autor" id="libro_autor" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Editorial</label>
                        <input type="text" class="form-control" name="editorial" id="libro_editorial">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Año</label>
                        <input type="number" class="form-control" name="año_publicacion" id="libro_año" min="1000" max="2100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Unificado Ejemplar (Crear/Editar) -->
<div class="modal fade" id="modalEjemplar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEjemplarTitulo"><i class="bi bi-plus-circle me-2"></i>Nuevo Ejemplar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="formEjemplar">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3" id="ejemplar_libro_select_container">
                        <label class="form-label">Libro *</label>
                        <select class="form-select" name="libro_isbn" id="ejemplar_libro_select" required>
                            <option value="">Selecciona un libro...</option>
                            {% for libro in libros %}
                            <option value="{{ libro.isbn }}">{{ libro.titulo }} - {{ libro.autor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3" id="ejemplar_codigo_container" style="display: none;">
                        <label class="form-label">Código</label>
                        <input type="text" class="form-control" id="ejemplar_codigo_display" disabled>
                        <small class="text-muted">Se genera automáticamente</small>
                    </div>
                    <div class="mb-3" id="ejemplar_estado_container" style="display: none;">
                        <label class="form-label">Estado *</label>
                        <select class="form-select" name="estado" id="ejemplar_estado">
                            <option value="disponible">Disponible</option>
                            <option value="prestado">Prestado</option>
                            <option value="mantenimiento">En Mantenimiento</option>
                            <option value="perdido">Perdido</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" id="ejemplar_obs" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Configurar búsqueda en tiempo real
    document.addEventListener('DOMContentLoaded', function() {
        setupSearch('q', 'tabla-libros');
    });
    
    // Limpiar modal libro para CREAR
    function limpiarModalLibro() {
        document.getElementById('modalLibroTitulo').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Libro';
        document.getElementById('formLibro').action = '{% url "registrar_libro" %}';
        document.getElementById('libro_isbn').value = '';
        document.getElementById('libro_isbn').disabled = false;
        document.getElementById('libro_titulo').value = '';
        document.getElementById('libro_autor').value = '';
        document.getElementById('libro_editorial').value = '';
        document.getElementById('libro_año').value = '';
    }
    
    // Cargar datos del libro para EDITAR
    function cargarLibroEnModal(isbn, titulo, autor, editorial, año) {
        document.getElementById('modalLibroTitulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Libro';
        document.getElementById('formLibro').action = '/libros/' + isbn + '/editar/';
        document.getElementById('libro_isbn').value = isbn;
        document.getElementById('libro_isbn').disabled = true;  // No permitir cambiar ISBN al editar
        document.getElementById('libro_titulo').value = titulo;
        document.getElementById('libro_autor').value = autor;
        document.getElementById('libro_editorial').value = editorial;
        document.getElementById('libro_año').value = año;
    }
    
    // Limpiar modal ejemplar para CREAR
    function limpiarModalEjemplar(isbnPreselect = '') {
        document.getElementById('modalEjemplarTitulo').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Nuevo Ejemplar';
        document.getElementById('formEjemplar').action = '{% url "registrar_ejemplar" %}';
        
        // Mostrar selector de libro, ocultar campos de edición
        document.getElementById('ejemplar_libro_select_container').style.display = 'block';
        document.getElementById('ejemplar_codigo_container').style.display = 'none';
        document.getElementById('ejemplar_estado_container').style.display = 'none';
        
        // Restaurar el required del selector de libro cuando se crea
        document.getElementById('ejemplar_libro_select').required = true;
        
        document.getElementById('ejemplar_libro_select').value = isbnPreselect;
        document.getElementById('ejemplar_libro_select').disabled = false;
        document.getElementById('ejemplar_obs').value = '';
    }
    
    // Cargar datos del ejemplar para EDITAR
    function cargarEjemplarEnModal(codigo, libroIsbn, estado, obs) {
        document.getElementById('modalEjemplarTitulo').innerHTML = '<i class="bi bi-pencil me-2"></i>Editar Ejemplar';
        // Construir la URL correctamente
        const baseUrl = window.location.origin;
        document.getElementById('formEjemplar').action = baseUrl + '/ejemplares/' + encodeURIComponent(codigo) + '/editar/';
        
        // Ocultar selector de libro, mostrar campos de edición
        document.getElementById('ejemplar_libro_select_container').style.display = 'none';
        document.getElementById('ejemplar_codigo_container').style.display = 'block';
        document.getElementById('ejemplar_estado_container').style.display = 'block';
        
        // Quitar el required del selector de libro cuando se edita
        document.getElementById('ejemplar_libro_select').required = false;
        
        document.getElementById('ejemplar_codigo_display').value = codigo;
        document.getElementById('ejemplar_estado').value = estado;
        document.getElementById('ejemplar_obs').value = obs;
    }
</script>
{% endblock %}